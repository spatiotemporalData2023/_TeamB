<!DOCTYPE html>
<html>
    <head>
        <script src='https://unpkg.com/@turf/turf@6/turf.min.js'></script>
        <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
        integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
        crossorigin=""/>
        <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
            integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
            crossorigin=""></script>
        <style>
            .center-content {
                text-align: center;
                margin: auto;
                max-width: 800px;
                padding: 10px;
            }

            #saveLocation, #locationDisplay, #nearestLocationDisplay {
                display: inline-block;
                vertical-align: middle;
                margin: 10px 5px;
            }

            #locationDisplay, #nearestLocationDisplay {
                border: 1px solid #ddd;
                background-color: #f9f9f9;
                padding: 5px 10px;
                max-width: 400px;
                overflow: hidden;
                white-space: nowrap;
                text-overflow: ellipsis;
            }

            #mapid {
                height: 700px;
            }
        </style>
    </head>
<body>
    <div class="center-content">
        <h1>Kanto school list</h1>
        <h2>~Which school is close to your locationï¼Ÿ~</h2>
        <p>Hello! This site displays information about school location near to your location in Kanto area.<br>
       You just need to click your location on the map.<br>
        Our system will find out the nearest school from you :)<br>
        </p>
    </div>

    <button id="saveLocation">Save Location</button>
    <div id="locationDisplay">Saved location will appear here</div>
    <div id="nearestLocationDisplay">Nearest location will appear here</div>
    <div id="mapid"></div>

    <script>
        var mymap = L.map('mapid').setView([35.66161697606394, 139.36643125161388], 15);

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(mymap);

        var marker = L.marker([35.66161697606394, 139.36643125161388]).addTo(mymap);
        marker.bindPopup('You are here at Tokyo Metropolitan University.').openPopup();

        var lastClickedLocation = null;

        function onMapClick(e) {
            marker.setLatLng(e.latlng)
                  .bindPopup("You clicked the map at " + e.latlng)
                  .openPopup();

            lastClickedLocation = e.latlng;
        }

        mymap.on('click', onMapClick);

        function mergeGeoJSONData(geojsonDataArray) {
            let features = [];
            geojsonDataArray.forEach(geojsonData => {
                features = features.concat(geojsonData.features);
            });
            return turf.featureCollection(features);
        }

        const geojsonUrls = [
            'https://raw.githubusercontent.com/spatiotemporalData2023/_TeamB/main/day14/Schoolmap_Search/data/P29-21_08.geojson',
            'https://raw.githubusercontent.com/spatiotemporalData2023/_TeamB/main/day14/Schoolmap_Search/data/P29-21_09.geojson',
            'https://raw.githubusercontent.com/spatiotemporalData2023/_TeamB/main/day14/Schoolmap_Search/data/P29-21_10.geojson',
            'https://raw.githubusercontent.com/spatiotemporalData2023/_TeamB/main/day14/Schoolmap_Search/data/P29-21_11.geojson',
            'https://raw.githubusercontent.com/spatiotemporalData2023/_TeamB/main/day14/Schoolmap_Search/data/P29-21_12.geojson',
            'https://raw.githubusercontent.com/spatiotemporalData2023/_TeamB/main/day14/Schoolmap_Search/data/P29-21_13.geojson',
            'https://raw.githubusercontent.com/spatiotemporalData2023/_TeamB/main/day14/Schoolmap_Search/data/P29-21_14.geojson'
        ];

        let allGeojsonData = [];
        let combinedFeatureCollection;

        Promise.all(geojsonUrls.map(url => fetch(url).then(resp => resp.json())))
            .then(data => {
                allGeojsonData = data;
                combinedFeatureCollection = mergeGeoJSONData(allGeojsonData);
            })
            .catch(error => console.error('Error loading GeoJSON:', error));

    var nearestMarker; // Marker for the nearest location
    var pathLine; // Line between saved and nearest location

document.getElementById('saveLocation').onclick = function() {
    // ...existing code...

    if (lastClickedLocation && combinedFeatureCollection) {
        // ...existing code to find the nearest location...

        if (nearest && nearest.properties && 'P29_004' in nearest.properties) {
            nearestDisplayElement.textContent = 'Nearest location: ' + nearest.properties.P29_004;

            // Remove existing nearest marker and line if they exist
            if (nearestMarker) {
                mymap.removeLayer(nearestMarker);
            }
            if (pathLine) {
                mymap.removeLayer(pathLine);
            }

            var nearestLatLng = L.latLng(nearest.geometry.coordinates[1], nearest.geometry.coordinates[0]);
            nearestMarker = L.marker(nearestLatLng).addTo(mymap);
            nearestMarker.bindPopup(nearest.properties.P29_004).openPopup();

            var latlngs = [
                [lastClickedLocation.lat, lastClickedLocation.lng],
                [nearest.geometry.coordinates[1], nearest.geometry.coordinates[0]]
            ];
            pathLine = L.polyline(latlngs, {color: 'blue'}).addTo(mymap);

            console.log("Added marker and line"); // Debugging
        } else {
            nearestDisplayElement.textContent = 'Nearest location found, but no specific name available';
            console.log("Nearest location found, but property P29_004 is missing"); // Debugging
        }
    } else {
        displayElement.textContent = 'No location selected to save or data not loaded';
        nearestDisplayElement.textContent = ''; // Clear the nearest location display
        console.log("Data not loaded or no location selected"); // Debugging
    }
};

    </script>
</body>
</html>


